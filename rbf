#!/usr/bin/env ruby

require 'io/console'

class BfInterpreter
  def initialize(debug = false, wrap_around = true)
    @option = Hash.new
    @option['debug'] = debug
    @option['wrap_around'] = wrap_around
  end

  def debug?
    @option['debug']
  end

  def debug=(debug)
    @option['debug'] = debug
  end

  def wrap_around?
    @option['wrap_around']
  end

  def wrap_around=(wrap_around)
    @option['wrap_around'] = wrap_around
  end

  def run(src)
    units = []

    # construct units
    File.open(src) do |file|
      units = construct_program_units(file)
    end

    # match brackets
    match_brackets(units)

    # do interpret
    tape = Array.new
    cell = 0
    unit = units[0]
    while unit != nil
      tape[cell] = BfCell.new(cell) if tape[cell] == nil

      STDERR.printf('%s', unit.instruction) if debug?

      case unit.instruction
        when '+' then tape[cell].increase(1, wrap_around?)
        when '-' then tape[cell].decrease(1, wrap_around?)
        when '<' then
          cell -= 1
          fail 'Cell position out of bound!' if cell < 0
        when '>' then cell += 1
        when ',' then
          tape[cell].value = STDIN.getch.ord
        when '.' then STDOUT.putc tape[cell].value
        when '[' then
          if tape[cell].value == 0
            unit = unit.match
            next
          end
        when ']' then
          if tape[cell].value != 0
            unit = unit.match
            next
          end
        else fail "Illegal instruction '#{unit.instruction}'!"
      end

      unit = unit.next
    end
  end

  private def construct_program_units(file)
    units = Array.new
    position = 0

    file.each_byte do |c|
      case c.chr
        when '+', '-', '<', '>', '[', ']', '.', ',' then
          unit = BfProgramUnit.new(c.chr)
          units[position - 1].next = unit if position > 0
          units[position] = unit
          position += 1
        else
          # other characters are considered as comments, do nothing
      end
    end

    units
  end

  private def match_brackets(units)
    units.each_index do |i|
      if units[i].instruction == '['
        level = 0
        units[i + 1 .. units.length - 1].each_index do |j|
          j += i + 1
          if units[j].instruction == '['
            level += 1
          elsif units[j].instruction == ']'
            if level > 0
              level -= 1
            else
              units[i].match = units[j]
              units[j].match = units[i]
              break
            end
          end
        end
        fail 'Unmatched brackets!' if level > 0
      end
    end
  end

  class BfCell
    attr_accessor :position, :value

    def initialize(position, value = 0)
      @position = position
      @value = value
    end

    def increase(increment = 1, wrap_around = true)
      if !wrap_around && (@value + increment < 0 || @value + increment > 255)
        fail 'Overflow or underflow happened while forbidden!'
      else
        @value = (@value + increment) % 256
      end
    end

    def decrease(decrement = 1, wrap_around = true)
      self.increase( -decrement, wrap_around)
    end
  end

  class BfProgramUnit
    attr_reader :instruction

    attr_accessor :match
    attr_accessor :next

    def initialize(instruction)
      @instruction = instruction
      @match = nil
      @next = nil
    end
  end
end

interpreter = BfInterpreter.new
interpreter.run(ARGV[0])
